<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Home</title>
    <style>
        html,
        body {
            background: linear-gradient(95deg, #00db7f 0%, #1DB954 40%, #03903e 100%);
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            font-family: Verdana, sans-serif, Helvetica, Arial;
        }

        .center-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #cc {
            background-color: #696969;
            border: none;
            color: #FFFFFF;
            cursor: pointer;
            font-size: 17px;
            font-weight: 700;
            font-family: Verdana, sans-serif, Helvetica, Arial;
            line-height: 41px;
            padding: 15px 40px;
            text-align: center;
            text-decoration: none;
            text-transform: uppercase;
            white-space: nowrap;
        }

        #cc:hover {
            /* background-color: #4b4b4b; */
            background-color: #00B44B;
            border: 1px solid #FFFFFF;
            transition: all 0.5s ease-in-out;
        }

        #spotify-logo {
            position: relative;
            height: 35px;
            top: 11px;
            margin-left: 10px;
        }
    </style>
</head>

<script src="https://cdn.jsdelivr.net/gh/pocketbase/js-sdk@master/dist/pocketbase.umd.js"></script>
<script>

    async function authenticateWithSpotify() {
        const client = new PocketBase('http://127.0.0.1:8090')

        client.authStore.loadFromCookie(document.cookie);

        client.authStore.onChange(() => {
            document.cookie = client.authStore.exportToCookie({ httpOnly: false });
        })

        const authData = await client.collection('users').authWithOAuth2({ provider: 'spotify' });

        console.log(client.authStore.isValid);
        console.log(client.authStore.token);
        console.log(client.authStore.model.id);
        console.log(authData);
        console.log(client.authStore);

        const data = {
            "name": authData.meta.name,
            "id_spotify" : authData.meta.id,
            "email": authData.meta.email,
            "avatarUrl" : authData.meta.avatarUrl,
        };

        await client.collection('users').update(client.authStore.model.id, data);

        window.location.href = '/track_list';
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('cc').addEventListener('click', function() {
            try {
                authenticateWithSpotify();
            } catch (e) {
                console.log(e);
            }
        });
    });

</script>
<body>
    <div class="center-container">
        <a id="cc"> Connect to Spotify
            <img src="static/spotify.png" alt="Spotify Logo" id="spotify-logo">
        </a>
    </div>
</body>

</html>